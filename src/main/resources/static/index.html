<html>
<head>
    <meta charset="UTF-8"/>
    <title>协作式在线程序编程</title>

    <link rel="stylesheet" type="text/css" href="css/codemirror.css">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <script type="text/javascript" src="js/codemirror.js"></script>
    <script type="text/javascript" src="js/clike.js"></script>
    <script src="/webjars/sockjs-client/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/stomp.min.js"></script>
    <script type="text/javascript" src="/webjars/jquery/jquery.min.js"></script>
    <style type="text/css">
        .CodeMirror{font-size:20px;background-color: #F9FAF9}
    </style>

</head>
<body style="height: 100%">


<div id="nav" style="width: 100%;height: 60px;background-color: orange;">
    <button style="float: left;margin: 10px" onclick="update()">SAVE</button>
    <button style="float: left;margin: 10px" onclick="run()">RUN</button>
    <button style="" onclick="Message()">MESSAGE</button>
    <button style="" onclick="disconnect()">DISCONNECT</button>

    <button id="rx" onclick="recievecode()">Normal</button>

    <img style="width: 46px;height: 46px;float: right;border-radius: 30px;background-color: red;margin: 7px;" src="img/head.png" />
</div>

<div id="editor" style="width: 70%;height: 100%;float: left;background-color: grey">
	<div style="height: 20px;width: 100%">Main.cpp</div>
	<textarea id="codemirror"></textarea>
  <div style="height: 100px;width: 100%;background-color: orange">
    <textarea readonly="true" id="console" style="width: 100%;height: 100%;resize:none;font-size: 20px;padding: 5px;color: blue;">hello world</textarea>
  </div>
</div>

<div id="chatroom" style="width: 30%;height: 100%;background-color: red;float: left">
  <div id="chatbox" style="background-color: #436289">
  <div id="chatcontent" class="content chat-block" tabindex="0" style="overflow-y: scroll;overflow-x: hidden;" >
    <div class="jimi_lists clearfix">
      <div class="header_img jimi3 fl"></div>
      <div class="bkbubble right">
        <p>换个气泡如何hhhhh</p>
      </div>
    </div>

    <div class="customer_lists clearfix">
      <div class="header_img jimi3" style="background: url(img/mine.jpg) no-repeat center;">
        <div class="header_img_hover"></div>
      </div>
      <div class="bkbubble left">
        <p>这个不错</p>
      </div>
    </div>
  </div>
</div>

<div style="height: 50px;width: 100%;background-color: #108359">
  <input id="inputBox" type="text" style="width: 80%;height: 50px;font-size: 20px;padding-left: 20px;float: left;border-left: none" name="">
  <div style="float: left;width: 20%;height: 50px;background-color: skyblue;cursor: pointer;line-height: 50px;text-align: center;color: white" onclick="sendMessage($('#inputBox').val())">发送</div>
  </div>
</div>
	
<script>
    var stompClient = null;
    var connected = false;
    var content = $("#chatcontent");
    var cursor = null;

    var rec = false;
    function recievecode(){
        $("#rx").val("Receiver");
        rec = true;
    }

    function connect() {
        stompClient = Stomp.over(new SockJS('/message'));
        stompClient.connect({}, function (frame) {
            connected = true;
            //console.log('Connected: ' + frame);
            stompClient.subscribe('/clients/message', function (message) {
                //console.log(message);

                if(JSON.parse(message.body).id < 0){
                    showGreeting("chat:"+JSON.parse(message.body).content);
                }else{
                    var data = JSON.parse(message.body).content;
                    var lines = "";
                    for(var i=0;i<data.length;i++){
                        lines += data[i];
                    }

                    editor.getDoc().setValue(lines);
                    //重置光标位置
                    editor.doc.setCursor(cursor);
                }

            });
        });

    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }

        console.log("Disconnected");
    }

    function sendName(message) {
        stompClient.send("/server/message", {}, JSON.stringify({'id':-1,'content': message}));
    }


    function showGreeting(message) {
        receiveMessage(message);
    }
  
    function sendMessage(msg){
        if(!connected){
            connect();
        }
        content.append("<div class=\"customer_lists clearfix\"><div class=\"header_img jimi3\" style=\"background: url(img/mine.jpg) no-repeat center;\"><div class=\"header_img_hover\"></div></div><div class=\"bkbubble left\"><p>"+msg+"</p></div></div>");
        content.scrollTop(content[0].scrollHeight);

        sendName(msg);
        $("#inputBox").val("");
    }

    function receiveMessage(msg){
        content.append("<div class=\"jimi_lists clearfix\"><div class=\"header_img jimi3 fl\"></div><div class=\"bkbubble right\"><p>"+msg+"</p></div></div>");
        content.scrollTop(content[0].scrollHeight);
    }
    var editor = CodeMirror.fromTextArea(document.getElementById("codemirror"), {
        lineNumbers: true,
        mode: "text/x-java"
    });

	var map = {"Ctrl-S": function(cm){update();}}
	editor.addKeyMap(map);

    var mac = CodeMirror.keyMap.default == CodeMirror.keyMap.macDefault;
    CodeMirror.keyMap.default[(mac ? "Cmd" : "Ctrl") + "-Space"] = "autocomplete";

	$.post("/file",function(data){
	    editor.getDoc().setValue(mtoString(data));
	});


	function mtoString(data){
        var lines = "";
        for(var i=0;i<data.length-1;i++){
            lines += data[i]+"\n";
        }
        lines +=data[i];
        return lines;
    }

    function update(){
        var content = editor.getValue();
        $.post("/update",{data:content,path:"/cooperativecoding/hello.c"}, function(data) {
            console.log(data);
        });
    }

    function run(){
        $.post("/run",function(data) {
            $("#console").val(data);
        });
    }

    function resize(){
  	    $("body").height(document.body.clientHeight-60);
  	    editor.setSize((document.body.clientWidth)*0.7+10,document.body.clientHeight-180);
        content.height(document.body.clientHeight-120);
    }

    $(document).ready(function(){
        connect();
        resize();

        content.scrollTop(content[0].scrollHeight);
    });

    window.onresize = function resizeBody(){
        resize();
    };

    //阻止内容相同时触发的change事件，防止死循环
    editor.on('beforeChange',function (cm,obj) {
        cursor = cm.doc.getCursor();
        if(cm.getValue()===mtoString(obj.text)){
            obj.cancel();
        }
    });

    //监听编辑器代码变动，同步到所有客户端
    editor.on('change',function (cm) {
        if(connected){
            stompClient.send("/server/message",{},JSON.stringify({'id':7,'content':cm.getValue()}));
        }
    });

</script>
</body>
</html>
